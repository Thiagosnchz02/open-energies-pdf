<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Open Energies ¬∑ Comparativa (asesor)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a0a; --card:#ffffff; --border:#e2e8f0; --ink:#0f172a; --muted:#64748b;
      --primary:#0ea5e9; --primary-600:#0284c7; --ring:#bae6fd;
    }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .page{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 18px;font-size:28px;letter-spacing:.2px}
    h2{margin:0 0 12px;font-size:20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:18px 0;box-shadow:0 6px 18px rgba(2,8,23,.04)}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none;background:#fff;transition:border-color .15s, box-shadow .15s}
    input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .panel{border:1px dashed var(--border);border-radius:12px;padding:12px}
    .panel h3{margin:0 0 8px;font-size:15px}
    .section-title{margin:14px 0 6px;font-weight:800;letter-spacing:.2px}
    .table{width:100%;border-collapse:separate;border-spacing:0;margin-top:6px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:13px}
    .table th{background:#f8fafc;text-align:left;font-weight:700}
    .table tr:last-child td{border-bottom:0}
    .toolbar{display:flex;gap:12px;justify-content:flex-end;border-top:1px solid var(--border);padding-top:12px;margin-top:12px}
    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:11px 16px;border-radius:10px;border:1px solid transparent;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--primary-600)}
    .btn.ghost{background:#fff;color:#0f172a;border-color:var(--border)}
    .btn.ghost:hover{border-color:var(--primary);color:var(--primary)}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px;color:#334155}
    .result{margin-top:10px;font-size:14px;color:#334155;white-space:pre-wrap}
    @media (max-width:900px){ .grid2,.split{grid-template-columns:1fr} }
    .cell-in{width:100%;border:0;padding:6px 8px}
  </style>
</head>
<body>
  <div class="page">
    <h1>Open Energies ¬∑ Comparativa (asesor)</h1>

    <div class="card">
      <div class="pill">üßë‚Äçüíº Vista asesor</div>
      <h2 style="margin-top:10px">4) Comparativa (asesor)</h2>
      <p class="muted">La tabla de <b>kWh por mes y peaje</b> se adapta a la tarifa y el sistema suma autom√°ticamente por periodo para el c√°lculo.</p>

      <div class="grid2">
        <div>
          <label>Tarifa</label>
          <select id="asesorTarifa">
            <option value="2.0TD">2.0TD</option>
            <option value="3.0TD">3.0TD</option>
            <option value="6.1TD">6.1TD</option>
          </select>
        </div>
        <div>
          <label>Alquiler contador (‚Ç¨/a√±o)</label>
          <input type="number" id="asesorFijos" step="0.01" value="14.41">
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Impuesto Electricidad (%)</label>
          <input type="number" id="asesorIE" step="0.0001" value="0.05112">
        </div>
        <div>
          <label>IVA (%)</label>
          <input type="number" id="asesorIVA" step="0.01" value="0.21">
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Nombre cliente (opcional)</label>
          <input type="text" id="infNombre" placeholder="Nombre / Raz√≥n social">
        </div>
        <div>
          <label>CIF</label>
          <input type="text" id="infCIF" placeholder="B12345678">
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>Direcci√≥n del suministro</label>
          <input type="text" id="infDireccion" placeholder="Calle, n¬∫, piso">
        </div>
        <div>
          <label>Poblaci√≥n</label>
          <input type="text" id="infPoblacion" placeholder="Ciudad / Provincia">
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>CUPS</label>
          <input type="text" id="infCUPS" placeholder="ES0021...">
        </div>
        <div>
          <label>Fecha de estudio</label>
          <input type="date" id="infFecha">
        </div>
      </div>

      <!-- Potencia contratada -->
      <div class="section-title">Potencia contratada (kW) por periodo</div>
      <table class="table" id="tablaPot">
        <thead><tr id="potHead"></tr></thead>
        <tbody><tr id="potValues"></tr></tbody>
      </table>

      <!-- kWh por mes y peaje (√∫nica tabla de energ√≠a) -->
      <div class="section-title">kWh por mes y peaje</div>
      <div id="sipsWrap" style="overflow:auto"></div>

      <!-- Precios -->
      <div class="split" style="margin-top:12px">
        <div class="panel">
          <h3>Plan ‚ÄúActual‚Äù (cliente)</h3>
          <div class="muted">Precios de su compa√±√≠a</div>
          <div class="section-title" style="margin-top:10px">‚Ç¨/kW¬∑a√±o (Potencia)</div>
          <table class="table">
            <thead><tr id="actPotHead"></tr></thead>
            <tbody><tr id="actPotValues"></tr></tbody>
          </table>
          <div class="section-title" style="margin-top:10px">‚Ç¨/kWh (Energ√≠a)</div>
          <table class="table">
            <thead><tr id="actEneHead"></tr></thead>
            <tbody><tr id="actEneValues"></tr></tbody>
          </table>
        </div>

        <div class="panel">
          <h3>Plan ‚ÄúPropuesta‚Äù (nuestra oferta)</h3>
          <div class="muted">Precios que aplicar√° Open Energies</div>
          <div style="margin:8px 0 2px">
            <label>Oferta</label>
            <select id="ofertaSelect"></select>
          </div>
          <div class="section-title" style="margin-top:10px">‚Ç¨/kW¬∑a√±o (Potencia)</div>
          <table class="table">
            <thead><tr id="proPotHead"></tr></thead>
            <tbody><tr id="proPotValues"></tr></tbody>
          </table>
          <div class="section-title" style="margin-top:10px">‚Ç¨/kWh (Energ√≠a)</div>
          <table class="table">
            <thead><tr id="proEneHead"></tr></thead>
            <tbody><tr id="proEneValues"></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Acciones -->
      <div class="toolbar">
        <button id="btnAsesorDemo" type="button" class="btn ghost">Rellenar DEMO</button>
        <button id="btnAsesorCalcular" type="button" class="btn">Calcular (asesor)</button>
        <button id="btnAsesorPDF" type="button" class="btn">Generar PDF (asesor)</button>
      </div>

      <pre id="asesorOut" class="result"></pre>
    </div>
  </div>

  <!-- ===== JS ===== -->
  <script>
    const PERIODS = {
      "2.0TD": { pot: ["P1","P2"], ene: ["E1","E2","E3"] },
      "3.0TD": { pot: ["P1","P2","P3","P4","P5","P6"], ene: ["E1","E2","E3","E4","E5","E6"] },
      "6.1TD": { pot: ["P1","P2","P3","P4","P5","P6"], ene: ["E1","E2","E3","E4","E5","E6"] }
    };
    const MESES = ["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"];
    const toNum = v => { const n = parseFloat(String(v).replace(',','.')); return Number.isFinite(n)?n:0; };
    const outPretty = (data) => (
`Tarifa: ${data.tarifa}

ACTUAL
- Potencia anual: ${data.actual.potencia_anual} ‚Ç¨
- Energ√≠a anual: ${data.actual.energia_anual} ‚Ç¨
- Fijos: ${data.actual.cargos_fijos_anual} ‚Ç¨
- Imp. Electricidad: ${data.actual.impuesto_electricidad} ‚Ç¨
- IVA: ${data.actual.iva} ‚Ç¨
= Total anual: ${data.actual.total_anual} ‚Ç¨  |  Mensual: ${data.actual.total_mensual} ‚Ç¨

PROPUESTA
- Potencia anual: ${data.propuesta.potencia_anual} ‚Ç¨
- Energ√≠a anual: ${data.propuesta.energia_anual} ‚Ç¨
- Fijos: ${data.propuesta.cargos_fijos_anual} ‚Ç¨
- Imp. Electricidad: ${data.propuesta.impuesto_electricidad} ‚Ç¨
- IVA: ${data.propuesta.iva} ‚Ç¨
= Total anual: ${data.propuesta.total_anual} ‚Ç¨  |  Mensual: ${data.propuesta.total_mensual} ‚Ç¨

AHORRO
- % Ahorro: ${data.ahorro_pct} %
- Ahorro Mes: ${data.ahorro_mensual} ‚Ç¨
- Ahorro A√±o: ${data.ahorro_anual} ‚Ç¨` );

    // refs
    const selTarifa = document.getElementById('asesorTarifa');
    const asesorFijos = document.getElementById('asesorFijos');
    const asesorIE = document.getElementById('asesorIE');
    const asesorIVA = document.getElementById('asesorIVA');
    const asesorOut = document.getElementById('asesorOut');

    const potHead = document.getElementById('potHead');
    const potValues = document.getElementById('potValues');

    const actPotHead = document.getElementById('actPotHead');
    const actPotValues = document.getElementById('actPotValues');
    const actEneHead = document.getElementById('actEneHead');
    const actEneValues = document.getElementById('actEneValues');
    const proPotHead = document.getElementById('proPotHead');
    const proPotValues = document.getElementById('proPotValues');
    const proEneHead = document.getElementById('proEneHead');
    const proEneValues = document.getElementById('proEneValues');

    const infNombre = document.getElementById('infNombre');
    const infDireccion = document.getElementById('infDireccion');
    const infPoblacion = document.getElementById('infPoblacion');
    const infCIF = document.getElementById('infCIF');
    const infFecha = document.getElementById('infFecha');
    const infCUPS = document.getElementById('infCUPS');
    const btnAsesorDemo = document.getElementById('btnAsesorDemo');
    const btnAsesorCalcular = document.getElementById('btnAsesorCalcular');
    const btnAsesorPDF = document.getElementById('btnAsesorPDF');

    const ofertaSelect = document.getElementById('ofertaSelect');
    const sipsWrap = document.getElementById('sipsWrap');

    // ===== Render inputs seg√∫n tarifa =====
    function renderPeriodInputs(){
      const t = selTarifa.value;
      const pots = PERIODS[t].pot;

      // Potencia
      potHead.innerHTML = ['<th>Periodo</th>'].concat(pots.map(p=>`<th>${p}</th>`)).join('');
      potValues.innerHTML = ['<td style="font-weight:600">kW</td>']
        .concat(pots.map(p=>`<td><input data-kind="pot_contr" data-key="${p}" type="number" step="0.0001" value="0"></td>`)).join('');

      // SIPS mensual
      renderSipsTable();

      // Precios cabeceras
      const enes = PERIODS[t].ene;
      actPotHead.innerHTML = ['<th>Periodo</th>'].concat(pots.map(p=>`<th>${p}</th>`)).join('');
      actPotValues.innerHTML = ['<td style="font-weight:600">‚Ç¨/kW¬∑a√±o</td>']
        .concat(pots.map(p=>`<td><input data-kind="act_pot" data-key="${p}" type="number" step="0.000001" value="0"></td>`)).join('');
      actEneHead.innerHTML = ['<th>Periodo</th>'].concat(enes.map(e=>`<th>${e}</th>`)).join('');
      actEneValues.innerHTML = ['<td style="font-weight:600">‚Ç¨/kWh</td>']
        .concat(enes.map(e=>`<td><input data-kind="act_ene" data-key="${e}" type="number" step="0.000001" value="0"></td>`)).join('');
      proPotHead.innerHTML = ['<th>Periodo</th>'].concat(pots.map(p=>`<th>${p}</th>`)).join('');
      proPotValues.innerHTML = ['<td style="font-weight:600">‚Ç¨/kW¬∑a√±o</td>']
        .concat(pots.map(p=>`<td><input data-kind="pro_pot" data-key="${p}" type="number" step="0.000001" value="0"></td>`)).join('');
      proEneHead.innerHTML = ['<th>Periodo</th>'].concat(enes.map(e=>`<th>${e}</th>`)).join('');
      proEneValues.innerHTML = ['<td style="font-weight:600">‚Ç¨/kWh</td>']
        .concat(enes.map(e=>`<td><input data-kind="pro_ene" data-key="${e}" type="number" step="0.000001" value="0"></td>`)).join('');
    }

    function renderSipsTable(){
      const t = selTarifa.value;
      const ePeriods = PERIODS[t].ene;

      let html = '<div style="min-width:760px"><table class="table" style="width:100%">';
      html += '<thead><tr><th>Peaje</th>' + MESES.map(m=>`<th>${m}</th>`).join('') + '</tr></thead><tbody>';

      for(const e of ePeriods){
        html += `<tr><td style="font-weight:600">${e}</td>`;
        for(let i=0;i<12;i++){
          html += `<td><input class="cell-in sips" data-e="${e}" data-m="${i}" type="number" step="0.0001" value="0"></td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table></div>';

      sipsWrap.innerHTML = html;
    }

    // ===== Ofertas backend =====
    let OFFERS_CACHE = {};
    async function loadOffers(){
      try{
        const res = await fetch('/offers');
        OFFERS_CACHE = await res.json();
      }catch{ OFFERS_CACHE = {}; }
      refreshOfferOptions();
    }
    function refreshOfferOptions(){
      const t = selTarifa.value;
      ofertaSelect.innerHTML = '<option value="">‚Äî Manual ‚Äî</option>';
      for(const [key,off] of Object.entries(OFFERS_CACHE)){
        if(off.tarifas && off.tarifas[t]){
          const opt = document.createElement('option');
          opt.value = key; opt.textContent = off.label || key;
          ofertaSelect.appendChild(opt);
        }
      }
    }
    function applySelectedOffer(){
      const key = ofertaSelect.value;
      const t = selTarifa.value;
      if(!key || !OFFERS_CACHE[key] || !OFFERS_CACHE[key].tarifas[t]) return;
      const cfg = OFFERS_CACHE[key].tarifas[t];

      document.querySelectorAll('input[data-kind="pro_pot"]').forEach(inp=>{
        const p = inp.dataset.key; const val = cfg.potencia ? cfg.potencia[p] : undefined;
        if(typeof val === 'number') inp.value = val;
      });
      document.querySelectorAll('input[data-kind="pro_ene"]').forEach(inp=>{
        const e = inp.dataset.key; const val = cfg.energia ? cfg.energia[e] : undefined;
        if(typeof val === 'number') inp.value = val;
      });
    }
    ofertaSelect.addEventListener('change', applySelectedOffer);

    // ===== Helpers =====
    function buildMap(selector){
      const out = {};
      document.querySelectorAll(selector).forEach(inp => { out[inp.dataset.key] = toNum(inp.value); });
      return out;
    }

    // Suma kWh anuales por periodo a partir de la tabla mensual SIPS
    function getEnergiaAnualFromSips(){
      const t = selTarifa.value;
      const enes = PERIODS[t].ene;
      const totals = {};
      enes.forEach(e => totals[e] = 0);
      sipsWrap.querySelectorAll('input.sips').forEach(inp=>{
        const e = inp.dataset.e;
        totals[e] += toNum(inp.value);
      });
      return totals;
    }

    function buildAsesorPayload(includeSuministro=false){
      const tarifa = selTarifa.value;
      const energia_kwh = getEnergiaAnualFromSips();
      const potencia_contratada_kw = buildMap('input[data-kind="pot_contr"]');
      const actual_precio_potencia = buildMap('input[data-kind="act_pot"]');
      const actual_precio_energia = buildMap('input[data-kind="act_ene"]');
      const propuesta_precio_potencia = buildMap('input[data-kind="pro_pot"]');
      const propuesta_precio_energia = buildMap('input[data-kind="pro_ene"]');

      const payload = {
        tarifa,
        energia_kwh,
        potencia_contratada_kw,
        actual: {
          nombre: "Tarifa actual",
          precio_potencia: actual_precio_potencia,
          precio_energia: actual_precio_energia,
          cargos_fijos_anual_eur: toNum(asesorFijos.value)
        },
        propuesta: {
          nombre: "Nuestra oferta",
          precio_potencia: propuesta_precio_potencia,
          precio_energia: propuesta_precio_energia,
          cargos_fijos_anual_eur: toNum(asesorFijos.value)
        },
        impuesto_electricidad_pct: toNum(asesorIE.value),
        iva_pct: toNum(asesorIVA.value)
      };

      if(includeSuministro){
        payload.suministro = {
          nombre_cliente: (document.getElementById('infNombre').value || ""),
          direccion: (document.getElementById('infDireccion').value || ""),
          poblacion: (document.getElementById('infPoblacion').value || ""),
          cif: (document.getElementById('infCIF').value || ""),
          fecha_estudio: (document.getElementById('infFecha').value || new Date().toISOString().slice(0,10)),
          cups: (document.getElementById('infCUPS').value || "")
        };
      }
      return payload;
    }

    function buildMonthlyPayloadFromAsesor() {
    const tarifa = selTarifa.value;
    const ePeriods = PERIODS[tarifa].ene;
    const pPeriods = PERIODS[tarifa].pot;

    // kWh por mes y peaje (usa los inputs id="kwh_E1_0"... "kwh_E3_11")
    const energia_kwh_mes = {};
    for (const e of ePeriods) {
      energia_kwh_mes[e] = [];
      for (let i = 0; i < 12; i++) {
        const el = document.getElementById(`kwh_${e}_${i}`);
        const v = el ? toNum(el.value) : 0;
        energia_kwh_mes[e].push(v);
      }
    }

    // Potencia contratada (los mismos inputs que ya usas en asesor)
    const potencia_contratada_kw = buildMap('input[data-kind="pot_contr"]');

    // Precios actual / propuesta
    const actual_precio_potencia   = buildMap('input[data-kind="act_pot"]');
    const actual_precio_energia    = buildMap('input[data-kind="act_ene"]');
    const propuesta_precio_potencia= buildMap('input[data-kind="pro_pot"]');
    const propuesta_precio_energia = buildMap('input[data-kind="pro_ene"]');
    const fijos = toNum(asesorFijos.value);

    const suministro = {
      direccion: infDireccion.value || "",
      poblacion: infPoblacion.value || "",
      cif:       infCIF.value || "",
      cups:      infCUPS.value || "",
      fecha_estudio: infFecha.value || new Date().toISOString().slice(0,10),
      nombre_cliente: (document.getElementById('infNombre')?.value || null)
    };

    return {
      tarifa,
      energia_kwh_mes,
      potencia_contratada_kw,
      actual:    { nombre: "Actual",    precio_energia: actual_precio_energia,    precio_potencia: actual_precio_potencia,    cargos_fijos_anual_eur: fijos },
      propuesta: { nombre: "Propuesta", precio_energia: propuesta_precio_energia, precio_potencia: propuesta_precio_potencia, cargos_fijos_anual_eur: fijos },
      iva_pct: toNum(asesorIVA.value),
      impuesto_electricidad_pct: toNum(asesorIE.value),
      suministro
    };
  }

    async function calcularAsesor(){
      asesorOut.textContent = 'Calculando...';
      try{
        const payload = buildAsesorPayload(false);
        const res = await fetch('/compare',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || 'Error');
        asesorOut.textContent = outPretty(data);
      }catch(e){ asesorOut.textContent = 'Error: ' + e.message; }
    }
    async function generarPDFAsesor() {
    try {
      const payload = buildMonthlyPayloadFromAsesor(); // <-- ahora usamos los kWh/mes
      const res = await fetch('/compare-report-monthly', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        let msg = 'Error al generar PDF';
        try { const j = await res.json(); msg = j.detail || msg; } catch {}
        throw new Error(msg);
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank'); // abre el PDF con el gr√°fico mensual
    } catch (e) {
      alert(e.message);
    }
  }

    // DEMO
    function setDemoValues(){
      selTarifa.value = "2.0TD"; renderPeriodInputs();

      // Potencia
      [...document.querySelectorAll('input[data-kind="pot_contr"]')]
        .forEach(inp=>{ inp.value = (inp.dataset.key==="P1"||inp.dataset.key==="P2")?2.5:0; });

      // Reparto mensual demo (s√≥lo para mostrar)
      const annual = {E1:1632.06,E2:999.56,E3:982.45};
      sipsWrap.querySelectorAll('input.sips').forEach(inp=>{
        const e = inp.dataset.e;
        const val = (annual[e]||0)/12;
        inp.value = val ? val.toFixed(4) : 0;
      });

      // Precios
      const actPot = {P1:36.257275,P2:13.127955};
      const actEne = {E1:0.376,E2:0.344,E3:0.344};
      const proPot = {P1:38.93,P2:20.69};
      const proEne = {E1:0.098155,E2:0.098155,E3:0.098155};
      document.querySelectorAll('input[data-kind="act_pot"]').forEach(i=>i.value = actPot[i.dataset.key]||0);
      document.querySelectorAll('input[data-kind="act_ene"]').forEach(i=>i.value = actEne[i.dataset.key]||0);
      document.querySelectorAll('input[data-kind="pro_pot"]').forEach(i=>i.value = proPot[i.dataset.key]||0);
      document.querySelectorAll('input[data-kind="pro_ene"]').forEach(i=>i.value = proEne[i.dataset.key]||0);

      asesorFijos.value = 14.41; asesorIE.value = 0.05112; asesorIVA.value = 0.21;
    }

    // Eventos / init
    selTarifa.addEventListener('change', () => { renderPeriodInputs(); refreshOfferOptions(); applySelectedOffer(); });
    document.getElementById('btnAsesorDemo').addEventListener('click', setDemoValues);
    document.getElementById('btnAsesorCalcular').addEventListener('click', calcularAsesor);
    document.getElementById('btnAsesorPDF').addEventListener('click', generarPDFAsesor);

    renderPeriodInputs();
    loadOffers().then(() => { refreshOfferOptions(); });
    setDemoValues();
  </script>
</body>
</html>